<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chart Diagnostic</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .chart-container { 
            width: 80%; 
            height: 400px; 
            margin: 0 auto; 
            border: 1px solid #ddd;
            padding: 10px;
        }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; }
        button { padding: 10px; margin: 5px; }
        .metric { 
            display: inline-block; 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin: 5px; 
            min-width: 150px;
        }
    </style>
</head>
<body>
    <h1>Chart Diagnostic Tool</h1>
    <div>
        <button onclick="fetchData()">Fetch Data</button>
        <button onclick="renderChart()">Render Chart</button>
        <button onclick="clearChart()">Clear Chart</button>
    </div>
    <div class="metrics">
        <div class="metric">Price: <span id="price">-</span></div>
        <div class="metric">Volatility: <span id="volatility">-</span></div>
        <div class="metric">Signals: <span id="signals">-</span></div>
    </div>
    <div class="chart-container">
        <canvas id="priceChart"></canvas>
    </div>
    <h3>Raw Data:</h3>
    <pre id="rawData">No data fetched yet.</pre>

    <script>
        let chartData = null;
        let chart = null;

        async function fetchData() {
            try {
                const response = await fetch('http://localhost:8001/price-feed');
                chartData = await response.json();
                document.getElementById('rawData').textContent = JSON.stringify(chartData, null, 2);
                
                // Check if we have no data
                if (chartData.no_data === true || !chartData.prices || chartData.prices.length === 0) {
                    document.getElementById('price').textContent = 'No data';
                    document.getElementById('volatility').textContent = 'No data';
                    document.getElementById('signals').textContent = 'No data';
                    return;
                }
                
                // Update metrics
                if (chartData && chartData.prices && chartData.prices.length > 0) {
                    document.getElementById('price').textContent = chartData.prices[chartData.prices.length-1].toFixed(2);
                    document.getElementById('volatility').textContent = chartData.volatility !== null ? chartData.volatility.toFixed(4) : 'N/A';
                    document.getElementById('signals').textContent = chartData.signals ? chartData.signals.length : '0';
                }
                
                console.log("Data fetched successfully:", chartData);
            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('rawData').textContent = "Error fetching data: " + error.message;
            }
        }

        function clearChart() {
            if (chart) {
                chart.destroy();
                chart = null;
            }
            const ctx = document.getElementById('priceChart').getContext('2d');
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        }

        function renderChart() {
            if (!chartData) {
                alert("No data available. Please fetch data first.");
                return;
            }
            
            // Check for no data flag
            if (chartData.no_data === true || !chartData.prices || chartData.prices.length === 0) {
                clearChart();
                const ctx = document.getElementById('priceChart').getContext('2d');
                ctx.font = '18px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No real data available yet. Start the bot to fetch live data.', ctx.canvas.width/2, ctx.canvas.height/2);
                return;
            }

            clearChart();
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Create timestamps array from Unix timestamps
            const labels = chartData.timestamps.map(ts => {
                const date = new Date(ts);
                return date.toLocaleTimeString();
            });
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Price',
                            data: chartData.prices,
                            borderColor: '#0077cc',
                            backgroundColor: 'rgba(0,119,204,0.1)',
                            pointRadius: 0,
                            borderWidth: 2,
                        },
                        {
                            label: 'Short MA',
                            data: chartData.short_ma,
                            borderColor: '#00cc77',
                            backgroundColor: 'rgba(0,204,119,0.1)',
                            pointRadius: 0,
                            borderWidth: 1,
                        },
                        {
                            label: 'Long MA',
                            data: chartData.long_ma,
                            borderColor: '#cc0077',
                            backgroundColor: 'rgba(204,0,119,0.1)',
                            pointRadius: 0,
                            borderWidth: 1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'BTC/USDT Price & Moving Averages' }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'Price (USDT)' }
                        }
                    }
                }
            });
            
            // Add signal markers to chart
            chartData.signals.forEach(sig => {
                const signalPoint = {
                    x: sig.index,
                    y: chartData.prices[sig.index]
                };
                
                chart.data.datasets.push({
                    label: sig.type === 'buy' ? 'Buy Signal' : 'Sell Signal',
                    data: [signalPoint],
                    pointBackgroundColor: sig.type === 'buy' ? '#00cc00' : '#cc0000',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 8,
                    pointHoverRadius: 10,
                    showLine: false
                });
            });
            
            chart.update();
            console.log("Chart rendered");
        }
    </script>
</body>
</html> 